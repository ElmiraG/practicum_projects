# Оценка рисков ДТП
Необходимо создать систему, которая могла бы оценить риск ДТП по выбранному маршруту движения. Под риском понимается вероятность ДТП с любым повреждением транспортного средства. Как только водитель забронировал автомобиль, сел за руль и выбрал маршрут, система должна оценить уровень риска. Если уровень риска высок, водитель увидит предупреждение и рекомендации по маршруту.
Идея создания такой системы находится в стадии предварительного обсуждения и проработки. Чёткого алгоритма работы и подобных решений на рынке ещё не существует. Текущая задача — понять, возможно ли предсказывать ДТП, опираясь на исторические данные одного из регионов.

**Идея решения задачи от заказчика:**
- Создать модель предсказания ДТП. Для модели выбрать тип виновника — только машина (car).
- Выбрать случаи, когда ДТП привело к любым повреждениям транспортного средства, кроме типа SCRATCH (царапина).
- Для моделирования ограничиться данными за 2012 год — они самые свежие.
- Обязательное условие — учесть фактор возраста автомобиля.
- На основе модели исследовать основные факторы ДТП.
- Понять, помогут ли результаты моделирования и анализ важности факторов ответить на вопросы:
    - Возможно ли создать адекватную системы оценки водительского риска при выдаче авто?
    - Какие ещё факторы нужно учесть?
    - Нужно ли оборудовать автомобиль какими-либо датчиками или камерой?
- Заказчик предлагает вам поработать с базой данных по происшествиям и сформировать свои идеи создания такой системы. 

# План по выполнению проекта
1. Загрузка данных
2. Первичное исследование таблиц
3. Cтатистический анализ факторов ДТП
4. Создание модели для оценки водительского риска
   - 4.1 Поиск лучшей модели
   - 4.2 Проверка лучшей модели
   - 4.3 Общий вывод по модели
5. Анализ важности факторов ДТП
6. Отчет по проекту

# Краткое описание таблиц 

- **collisions** — общая информация о ДТП. Имеет уникальный case_id. Эта таблица описывает общую информацию о ДТП. Например, где оно произошло и когда.
- **parties** — Имеет неуникальный case_id, который сопоставляется с соответствующим ДТП в таблице collisions. Каждая строка здесь описывает одну из сторон, участвующих в ДТП. Если столкнулись две машины, в этой таблице должно быть две строки с совпадением case_id. Если нужен уникальный идентификатор, это case_id and party_number.
- **vehicles** — информация о пострадавших машинах. Имеет неуникальные case_id и неуникальные party_number, которые сопоставляются с таблицей collisions и таблицей parties. Если нужен уникальный идентификатор, это case_id and party_number.

**Целевой признак**

- **at_fault** — (виновник) в таблице parties

# Отчет по проекту
**При создание модели были проведены следущие шаги:**

**1. Первичное исследование исходных таблиц:**
- Проверка соответствия количества таблиц и их названий
- Проверка набора данных в таблицах
- Проверка общего ключа
**2. Статистический анализ факторов ДТП.** 
Проанализировано:

**2.1. Время:**
- Большинство аварий происходит в первой половине года, с января по май (9.2-9.9%), с пиком в марте и наименьшим количеством в феврале. Во второй половине года, с июня по декабрь, доля аварий составляет 7.4-8%, с наименьшим числом случаев в июне, июле и ноябре (по 7.4%).
- Чаще всего происходят аварии по субботам - в 16.3% случаев, в понедельник вероятность наиболее низкая - 12.1%
- Чаще всего аварии происходят с 15 по 17 часов, что составляет 22.0% случаев, в то время как наименьшее количество аварий приходится на период с 0 до 6 утра - 13.7%.

**2.2. Серьезность повреждений:**
- Большинство аварий, а именно 90.5%, происходят на сухих дорогах, в то время как 9.0% случаев приходится на влажные дороги, 0.5% - на заснеженные и 0.1% - на грязные. Это объясняется тем, что в хорошую погоду больше людей выезжает на дороги, в то время как в плохую погоду активность снижается.

**2.3. Причины ДТП:**
- В 45.1% случаев, когда происходят аварии с участием других автомобилей, виновным оказывается клиент. Если же причиной сталы дорожные знаки, отбойник или другие факторы, клиент чаще всего остается невиновным, за исключением случаев, связанных со строениями, где вероятность вины клиента немного выше.

- Почти в половине случаев (53.9%) неизвестно состояние участника аварии. В случаях, когда состояние участника не установлено, вероятность его вины составляет 42.3%. Также видно, что наличие алкоголя в организме значительно увеличивает вероятность стать виновником аварии.

**2.4. Влияние характеристик автомобиля:**
- Хотя седаны и купе чаще участвуют в авариях из-за их распространенности на дорогах, вероятность попадания в аварию зависит от типа кузова автомобиля: минивены имеют немного более высокий процент аварийности, чем купе, в то время как седаны и хэтчбеки демонстрируют более низкие показатели вероятности попадания в аварию.

- Наблюдается небольшое различие в вероятности попадания в аварию в зависимости от типа коробки передач: автомобили с механической коробкой передач имеют чуть большую вероятность оказаться в аварии, чем те, у которых установлена автоматическая коробка передач.

- Нет явной корреляции между возрастом автомобиля и вероятностью его участия в авариях.

**2.5. Факторы аварии:**
- 95.3% аварий произошли из-за нарушения правил дорожного движения.
- В Лос-Анджелесе происходит наибольшее количество аварий, однако вероятность стать виновником аварии там составляет 43.99%, что ниже, чем в Ориндже и Сан-Диего.
- Аварии чаще всего случаются на шоссе (81.5%), реже на рампе (13.4%) и на перекрестке (5.2%). Вероятность стать виновником аварии на рампе немного выше, чем на других типах дорог.
- Самые распространенные виды дорожных происшествий включают столкновение сзади, боковой удар и боковое столкновение, где вероятность оказаться виновником составляет менее 50%.
- Случаи аварий, связанных с опрокидыванием машины и ударом объекта, имеют высокий процент виновности водителей.

**3. Создание модели для оценки водительского риска:**

**3.1. Подготовка набора данных.**

**3.2. Предобработка и анализ отобранных данных:**
**Проанализировано:**
- В основном данные об авариях за первую половину года.
- Распределение аварий по дням недели и часам соответствует распределению из первичной таблицы.
- Признак at_fault распределен сбалансированно: распределение 1 и 0 составляет 51% и 49% соответственно.
- Изначально отобранные признаки party_drug_physical и road_condition_1 удалены. Первый — из-за большого количества пропусков в данных, второй — из-за того, что 97% данных относятся к одной категории, что делает признак неинформативным.
- В темное время суток шанс стать виновником аварии выше.
- Вероятность стать виновником аварии на второстепенной дороге выше.
- Когда состояние участника неизвестно или он точно пьян, вероятность его вины в аварии возрастает.
- Когда погода не ясная, вероятность быть виновником аварии чуть выше.

**Обработка данных:**
- В столбце lighting объединены категории 'dark with no street lights' и 'dark with street lights not functioning', так как с точки зрения водителя, категории объясняют одну и ту же ситуацию.
- В столбце county_city_location я оставила первые пять значений, а остальные объединила в other.
- Из численного признака distance я создала булев признак, обозначив присутствие на главной дороге как True.
- Значения "impairment unknown" и "not applicable" объединены в категорию 'unknown'. Также объединены значения "had been drinking, under influence", "had been drinking, impairment unknown", "had been drinking, not under influence" под общим термином "had been drinking".
- В столбце weather1 категории fog, snowing, wind объединены с other.
- Проведена проверка на наличие дубликатов.
- Пропуски заполнены медианными значениями.

**3.4. Подготовка обучающей и тестовой выборки**

**3.5. Поиск лучшей модели: обучение и анализ**

Созданы три модели: RandomForestClassifier, CatBoostClassifier и LGBMClassifier. Каждая с перебором гиперпараметров.

Расчет моделей происходит как с применением SMOTETomek, так и с балансировкой классов с помощью гиперпараметров. 

В качестве метрики применяется average_precision.

**Лучашя модель RandomForestClassifier с применением SMOTETomek, с параметрами:**
- n_estimators = 150
- max_depth = 6,
- min_samples_split = 2

**3.6. Проверка лучшей модели**

- Истинно отрицательных ответов (не виновен в аварии) 0.32, истинно положительных ответов (виновен в аварии) TР = 0.27.
- Ложно положительных предсказаний меньше ложно отрицательных: 0.088 и 0.32, соответственно.

По результатам анализа, модель способна верно определить вину в аварии с вероятностью 0.27. Однако стоит отметить, что с вероятностью 0.32 действительно виновные лица могут остаться без уведомления от компании.

- Кривая ROC:
- Кривая ROC расположена выше кривой случайных ответов. Значение AUC = 0.64.

- Точность и полнота:
Точность составляет 0.75, что означает, что когда модель предсказывает положительный класс, она правильно делает это примерно в 75% случаев. Полнота равна 0.45, что указывает на то, что модель успешно идентифицирует примерно 45% всех реальных положительных случаев в данных.
  
**3.7.Анализ важностей факторов ДТП**

Модель посчитала важными такие признаки как:
- трезвость водителя
- время суток поездки
- освещение
- день недели
- проходит ли поездка по главной дороге

Так как была проанализировано ранее зависимость целевым признаком и уровнем трезвости водителя (самым важным признаком модели), - был проведен анализ следующего по значимости признака - это время суток.

Судя по графику, с 22 часов до 5 утра вероятность стать виновником аварии увеличивается. Кроме того, есть небольшой пик вероятности в 14 и 20 часов.

Разработка надежной системы оценки рисков при предоставлении автомобиля водителю - сложная задача. Наличие используемых признаков недостаточно, хотя, безусловно, такие данные как проверка трезвости водителя, а также анализ времени суток является важными составляющими модели. Для проверки трезвости водителя можно использовать электронный алкотестер. При безконтактной аренде автомобилей алкотестеры могут быть установлены в машинах с возможностью автоматической отправки результатов в базу данных компании, чтобы убедиться, что в трубку дышит именно водитель, добавить камеру, направленную на водительское место. В случае обнаружения алкоголя у водителя ему сообщается об отказе в предоставлении автомобиля.

Создание адекватной системы оценки риска при выдаче автомобилей в коршеринговой компании вполне возможно и даже необходимо для минимизации потенциальных финансовых потерь и снижения риска дорожнотраснспортных происшествий, способных нанести ущерб здоровью всех участников ДТП, привести к гибели людей. 

Я считаю, что также крайне важно дополнить количество признаков для анализа модели: 
- состояние автомобиля до выдачи ее клиенту; 
- учитывать стаж вождения, историю участия в авариях данного клиента, особенно если он ранее уже пользовался услугами этой каршеринговой компании.
- следует детально анализировать предполагаемые маршруты поездок, включая изучение статистики дорожных происшествий на различных участках и в разное время, что также влияет на оценку рисков. 
